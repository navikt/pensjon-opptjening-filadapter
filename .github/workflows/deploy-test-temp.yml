name: 'Deploy to dev (temp)'

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Which version to deploy (e.g. 2025.10.01-12.55-a1b2c3d)'
        required: true

jobs:
  tagAndDeploy:
    name: 'Tag and deploy'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      id-token: write
    steps:
      - name: 'Checkout repository'
        uses: actions/checkout@v5

      - name: 'Fetch NAIS information'
        uses: nais/login@v0
        id: nais-login
        with:
          team: 'pensjonopptjening'

      - name: 'Set variables'
        run: |
          echo "DATETIME=$(TZ=Europe/Oslo date '+%Y-%m-%d_%H.%M.%S')" >> $GITHUB_ENV

          echo "REPO=${{ steps.nais-login.outputs.registry }}" >> $GITHUB_ENV
          echo "IMAGE=${{ steps.nais-login.outputs.registry }}/pensjon-opptjening-filadapter:${{ github.event.inputs.version }}" >> $GITHUB_ENV
          echo "IMAGE_BASE=${{ steps.nais-login.outputs.registry }}/pensjon-opptjening-filadapter" >> $GITHUB_ENV

      - name: 'Information'
        id: info
        run: |
          echo "DATETIME: $DATETIME"
          echo "IMAGE: $IMAGE"
          echo "IMAGE: $REPO"
          echo "IMAGE_BASE: $IMAGE_BASE"

      - name: 'Tag image'
        run: |
          docker pull "$IMAGE"
          docker tag "$IMAGE" "$IMAGE_BASE:devtest"
          docker tag "$IMAGE" "$IMAGE_BASE:devtest-$DATETIME"
          docker push --all-tags "$IMAGE_BASE"

      - name: 'Deploy to Q2'
        uses: nais/deploy/actions/deploy@v2
        env:
          RESOURCE: .nais/dev-fss-q2.yaml
          IMAGE: '${{ env.IMAGE }}'
          CLUSTER: dev-gcp
